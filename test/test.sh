#!/bin/bash

function assert_eq() {
   local s1="$1"
   local s2="$2"
   if [ "$s1" != "$s2" ]; then
      echo >&2 "left:  $s1"
      echo >&2 "right: $s2"
      exit 1
   fi
}

wallet_cli="../wallet-cli"

echo "(print \"hello world\")" > /tmp/foo.clar

echo "Test generate-account..."
assert_eq \
   "$($wallet_cli generate-account -s - 1 < ./test-seed-phrase.txt)" \
   '{"stxPrivateKey":"2ca3ed6879438f7d3325159885c8f80f278563c03df042e3e799057f9dbc458a01","dataPrivateKey":"895c2534dfa5ebfc8932b770b31943bb39539a362a410a187d35f81d05046134","appsKey":"xprvA15Hx1JDPVphCBAocvNTX3eDDKPu7ghnRWAFg4HV7rkkcQ1yAS6pnTyz1cvFo8XzhUke92dP6W6BuiKybYNdhNZtQEAtpJLAy9pyJQbkaU6","salt":"9653dd9da8e8c9cebc70448052ec2119bfc71a095a3306583b15bb487d7b14a0","index":1,"stxAddress":"SPM8JZ8KXYR5YD99FKDN92S3SFZ2TKV5580CAJ55"}'
    

echo "Test token-transfer..."
assert_eq \
   "$($wallet_cli token-transfer -N "http://52.0.54.100:20443" -m "abcde" -f 123 -n 456 -s - -A 1 -a "on-chain" ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS 789 < ./test-seed-phrase.txt | jq -r)" \
   "0000000001040028897d13efb05f35297cdb548b23cbfe2d4f652a00000000000001c8000000000000007b00014ab2550377c630d37f96365357bce1317f8fb62823feb9bbab20ae52b4c752af4397565c79401cac4ed79dcbd4592cdd1dea30f494578b75d2179dc84be24f5801020000000000051a634d03a67375b7d53fbe11d63835a5df6d989bc5000000000000031561626364650000000000000000000000000000000000000000000000000000000000"

assert_eq \
   "$($wallet_cli token-transfer -t -N "http://52.0.54.100:20443" -m "abcde" -f 123 -n 456 -s - -A 1 -a "off-chain" ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS 789 < test-seed-phrase.txt | jq -r)" \
   "8080000000040028897d13efb05f35297cdb548b23cbfe2d4f652a00000000000001c8000000000000007b000121ccac8b4f0a0b0462ccb819441093dddaa049699bfa36c8fa50df0a7b8b74f402e0c6db4904e5cc9d8f8ada666ef72905d6a692e923b13fa53f7550fd13277602020000000000051a634d03a67375b7d53fbe11d63835a5df6d989bc5000000000000031561626364650000000000000000000000000000000000000000000000000000000000"

assert_eq \
   "$($wallet_cli token-transfer -t -N "http://52.0.54.100:20443" -m "abcde" -f 123 -n 456 -s - -A 1 -a "off-chain" ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.foo 789 < test-seed-phrase.txt | jq -r)" \
   "8080000000040028897d13efb05f35297cdb548b23cbfe2d4f652a00000000000001c8000000000000007b00002760413c82d7c699065c4700c2280415add7d76778014c5bcd98221a19bcfb8b3a8e9f749a3c79e0467620554482a4b6ebcf37236446f7dbfa400616ab7c08bf02020000000000061a634d03a67375b7d53fbe11d63835a5df6d989bc503666f6f000000000000031561626364650000000000000000000000000000000000000000000000000000000000"

assert_eq \
   "$($wallet_cli token-transfer -N "http://52.0.54.100:20443" -m "abcde" -f 123 -n 456 -k "32e0ae92b4cdd601480e22ad047364552ac1416be90ce9c72f6b5f51d4e4d8ce01" -A 1 -a "on-chain" ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS 789 | jq -r)" \
   "00000000010400ff5511dd87c807d195b04e8636100bcba1fb7eea00000000000001c8000000000000007b00004425f681c307e58ef865d2de6ced03f424704ffaa4a8ad81691f086bbc26752e76a1b4f16de686130ca3300e36231a6ca1d4917e1235ef2dd3708138df7af2c301020000000000051a634d03a67375b7d53fbe11d63835a5df6d989bc5000000000000031561626364650000000000000000000000000000000000000000000000000000000000" 

echo "Test contract-publish..."
assert_eq \
   "$($wallet_cli contract-publish -N "http://52.0.54.100:20443" -f 123 -n 456 -s - -A 1 -a "on-chain" foo /tmp/hello.clar < ./test-seed-phrase.txt | jq -r)" \
   "0000000001040028897d13efb05f35297cdb548b23cbfe2d4f652a0000000000000000000000000000007b000116c786278fbfbbd7ef888b29ccd014658b193e5e9e9d71ade292b1181d25969a66ab925f1522c4773999d17f6cfea633172bda3bd61dbce957927c7faa435e4a0102000000000103666f6f00000016287072696e74202268656c6c6f20776f726c6422290a"

assert_eq \
   "$($wallet_cli contract-publish -N "http://52.0.54.100:20443" -f 123 -n 456 -k "32e0ae92b4cdd601480e22ad047364552ac1416be90ce9c72f6b5f51d4e4d8ce01" -A 1 -a "on-chain" foo /tmp/hello.clar | jq -r)" \
   "00000000010400ff5511dd87c807d195b04e8636100bcba1fb7eea0000000000000000000000000000007b0000e0ed0a74b18a917efb284654923792a5c85e133494ffc0c88443f5d0558206b24f3b04f4d87e3d781820e4b538480d0d18983d540dff9e28bf6405719142f7790102000000000103666f6f00000016287072696e74202268656c6c6f20776f726c6422290a"

assert_eq \
   "$($wallet_cli contract-publish -N "http://52.0.54.100:20443" -f 123 -n 456 -s - -A 1 -a "on-chain" -p "allow stx ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS <= 1 ft ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS >= ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.bar stackaroo 2 nft ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS keeps ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.baz quux 09" foo /tmp/hello.clar < ./test-seed-phrase.txt | jq -r)" \
   "0000000001040028897d13efb05f35297cdb548b23cbfe2d4f652a0000000000000000000000000000007b00004ca81cbc4221c03ed656550057bb7d1733485dd0b634836d9cf6d2584acd5dd031415c01375ea0383e05fa150faff92478ad55bdf1fbaee7574025721d41cb4c01010000000300021a634d03a67375b7d53fbe11d63835a5df6d989bc505000000000000000101021a634d03a67375b7d53fbe11d63835a5df6d989bc51a634d03a67375b7d53fbe11d63835a5df6d989bc50362617209737461636b61726f6f02000000000000000202021a634d03a67375b7d53fbe11d63835a5df6d989bc51a634d03a67375b7d53fbe11d63835a5df6d989bc50362617a047175757809110103666f6f00000016287072696e74202268656c6c6f20776f726c6422290a"

echo "Test contract-call..."

assert_eq \
   "$($wallet_cli contract-call -N "http://52.0.54.100:20443" -f 123 -n 456 -s - -A 1 -a "on-chain" -p "allow stx ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS <= 1 ft ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS >= ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.bar stackaroo 2 nft ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS keeps ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.baz quux 09" ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.foo bar-func 0100000000000000000000000000000003 09 < ./test-seed-phrase.txt | jq -r )" \
   "0000000001040028897d13efb05f35297cdb548b23cbfe2d4f652a0000000000000000000000000000007b00019428c5f41c8d8a96b35fbbbd36bcbf03ba2fc0ca6e5e9a035079771152f4f15448204a99551a7f34bbde43d041c4ca48969b65c24efb19ece24e813d50993fad01010000000300021a634d03a67375b7d53fbe11d63835a5df6d989bc505000000000000000101021a634d03a67375b7d53fbe11d63835a5df6d989bc51a634d03a67375b7d53fbe11d63835a5df6d989bc50362617209737461636b61726f6f02000000000000000202021a634d03a67375b7d53fbe11d63835a5df6d989bc51a634d03a67375b7d53fbe11d63835a5df6d989bc50362617a04717575780911021a634d03a67375b7d53fbe11d63835a5df6d989bc503666f6f086261722d66756e6300000002010000000000000000000000000000000309"

assert_eq \
   "$($wallet_cli contract-call -N "http://52.0.54.100:20443" -f 123 -n 456 -k "32e0ae92b4cdd601480e22ad047364552ac1416be90ce9c72f6b5f51d4e4d8ce01" -A 1 -a "on-chain" -p "allow stx ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS <= 1 ft ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS >= ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.bar stackaroo 2 nft ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS keeps ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.baz quux 09" ST1HMT0X6EDTVFN9ZQR8XCE1NMQFPV64VRQWXV8WS.foo bar-func 0100000000000000000000000000000003 09 | jq -r )" \
   "00000000010400ff5511dd87c807d195b04e8636100bcba1fb7eea0000000000000000000000000000007b0001d8c4f8db539f60733a7371b685fe6c0aa853bb887f40c5c5dbc58278e866ad9759aaaca7da790ff5bf850150be19c053c73dabd6f61c090821018d48934aa20d01010000000300021a634d03a67375b7d53fbe11d63835a5df6d989bc505000000000000000101021a634d03a67375b7d53fbe11d63835a5df6d989bc51a634d03a67375b7d53fbe11d63835a5df6d989bc50362617209737461636b61726f6f02000000000000000202021a634d03a67375b7d53fbe11d63835a5df6d989bc51a634d03a67375b7d53fbe11d63835a5df6d989bc50362617a04717575780911021a634d03a67375b7d53fbe11d63835a5df6d989bc503666f6f086261722d66756e6300000002010000000000000000000000000000000309"
